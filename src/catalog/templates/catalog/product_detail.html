{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ product.title|default:product }}{% endblock %}

{% block content %}
<div class="container">
  <p style="margin-bottom: 24px;"><a href="{% url 'catalog:product_list' %}" class="btn secondary" style="width: auto; padding: 8px 16px;">← {% trans "Назад в каталог" %}</a></p>

  {# Обертка для мобильной адаптации #}
  <div class="product-detail grid-2" style="align-items: flex-start;">

    <!-- Левая колонка: Галерея -->
    <div class="gallery" id="gallery">
      <div class="main">
        <div class="main img-frame">
          {% with first=product.images.all.0 %}
            {% if first %}
              <img id="mainImage" src="{{ first.file.url }}" alt="{{ first.alt|default:product }}" class="photo-shadow">
            {% else %}
              <div style="aspect-ratio: 4/3; background: #f5f5f7; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                {% trans "Нет изображения" %}
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
      {% if product.images.all|length > 1 %}
      <div class="thumbs" id="thumbs">
        {% for img in product.images.all %}
          <img src="{{ img.file.url }}" alt="{{ img.alt|default:product }}" data-src="{{ img.file.url }}"{% if forloop.first %} class="active"{% endif %}>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- Правая колонка: Информация о товаре -->
    <div class="card" style="padding: 24px;">
      {# Этот класс pd-title нужен для reorder на мобилке #}
      <h1 class="pd-title" style="font-size: clamp(24px, 4vw, 32px); line-height: 1.2; margin-bottom: 12px;">{{ product.title|default:product }}</h1>

      <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 16px;">
        <div class="badge">{% trans "Сост." %} {{ product.condition }}</div>
        <span style="color: var(--text-secondary); font-size: 15px;">
        {% blocktrans with gb=product.storage_gb color=product.color %}
          {{ gb }} GB · {{ color }}
        {% endblocktrans %}
        </span>
      </div>

      <div style="margin-bottom: 24px;">
        <span class="price" style="font-size: 36px;">{{ product.price }} {{ product.currency }}</span>
        {% if product.old_price %}<s style="margin-left: 12px; font-size: 20px; color: var(--text-secondary);">{{ product.old_price }} {{ product.currency }}</s>{% endif %}
      </div>

      <div style="margin-bottom: 24px; color: var(--text-secondary); line-height: 1.6;">{{ product.description|default:""|linebreaks }}</div>

      <form action="/cart/add/" method="post">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <button class="btn" type="submit" style="width: 100%;">{% trans "Добавить в корзину" %}</button>
      </form>
    </div>
  </div>

  {% if related %}
    <h2 class="section-title" style="margin-top: 80px;">{% trans "Похожие товары" %}</h2>
    <div class="product-grid">
      {% for p in related %}
        <div class="product-card">
          <a href="{% url 'catalog:product_detail' p.base_slug %}" class="product-link">
            <div class="img-frame">
              {% with img=p.images.first %}
                {% if img %}<img src="{{ img.file.url }}" class="product-img" alt="{{ p.translations.title|default:p }}">{% endif %}
              {% endwith %}
            </div>
            <div class="pad">
              <div class="product-title">{{ p.title|default:p }}</div>
              <div class="price" style="margin-top: 8px;">{{ p.price }} {{ p.currency }}</div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>
  <script>
    (function(){
      var thumbs = document.getElementById('thumbs');
      var main = document.getElementById('mainImage');
      if(!thumbs || !main) return;
      thumbs.addEventListener('click', function(e){
        if(e.target && e.target.tagName === 'IMG'){
          var src = e.target.getAttribute('data-src');
          if(src){ main.setAttribute('src', src); }
          var imgs = thumbs.querySelectorAll('img');
          imgs.forEach(function(img){ img.classList.remove('active'); });
          e.target.classList.add('active');
        }
      });
    })();
  </script>
{% endblock %}