{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ product.title|default:product }}{% endblock %}

{% block content %}
  <p><a href="/catalog/" class="btn secondary">← {% trans "Каталог" %}</a></p>

  <div class="grid" style="grid-template-columns: 1.2fr 1fr;">
    <div class="gallery" id="gallery">
      <div class="main">
        <div class="main img-frame">
          {% with first=product.images.all.0 %}
            {% if first %}
              <img id="mainImage" src="{{ first.file.url }}" alt="{{ first.alt|default:product }}" class="product-img">
            {% else %}
              {% trans "No image" as no_image %}
              {% trans "No photo" as no_photo %}
              <img
                id="mainImage"
                src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='900'><rect fill='%23fff' width='100%' height='100%'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='32' fill='%23999'>{{ no_image|urlencode }}</text></svg>"
                alt="{{ no_photo }}"
                class="product-img">
            {% endif %}
          {% endwith %}
        </div>
      </div>
      <div class="thumbs" id="thumbs">
        {% for img in product.images.all %}
          <img src="{{ img.file.url }}" alt="{{ img.alt|default:product }}" data-src="{{ img.file.url }}"{% if forloop.first %} class="active"{% endif %}>
        {% endfor %}
      </div>
    </div>

    <div>
      <h1>{{ product.title|default:product }}</h1>
      <div class="badge">{% trans "Сост." %} {{ product.condition }}</div>

      {% blocktrans with gb=product.storage_gb color=product.color %}
        {{ gb }} GB · {{ color }}
      {% endblocktrans %}

      <p class="price">{{ product.price }} {{ product.currency }}</p>
      {% if product.old_price %}<p><s>{{ product.old_price }} {{ product.currency }}</s></p>{% endif %}
      <div style="margin:12px 0;">{{ product.description|default:"" }}</div>

      <form action="/cart/add/" method="post">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <button class="btn" type="submit">{% trans "В корзину" %}</button>
      </form>
    </div>
  </div>

  {% if related %}
    <h2 style="margin-top:24px;">{% trans "Похожие" %}</h2>
    <div class="grid" style="grid-template-columns: repeat(4, 1fr);">
      {% for p in related %}
        <div class="card">
          <a href="/p/{{ p.base_slug }}/" style="text-decoration:none;color:inherit;">
            <div class="img-frame">
              {% with img=p.images.first %}
                {% if img %}<img src="{{ img.file.url }}" class="product-img" alt="">{% endif %}
              {% endwith %}
            </div>
            <div style="margin-top:8px;">{{ p.title|default:p }}</div>
            <div class="price">{{ p.price }} {{ p.currency }}</div>
          </a>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <script>
    (function(){
      var thumbs = document.getElementById('thumbs');
      var main = document.getElementById('mainImage');
      if(!thumbs || !main) return;
      thumbs.addEventListener('click', function(e){
        if(e.target && e.target.tagName === 'IMG'){
          var src = e.target.getAttribute('data-src');
          if(src){ main.setAttribute('src', src); }
          var imgs = thumbs.querySelectorAll('img');
          imgs.forEach(function(img){ img.classList.remove('active'); });
          e.target.classList.add('active');
        }
      });
    })();
  </script>
{% endblock %}
