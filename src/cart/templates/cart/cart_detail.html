{% extends "base.html" %}
{% load cart_extras %}
{% load i18n %}

{% block title %}{% trans "Корзина" %}{% endblock %}

{% block content %}
<div class="container">
  <h1 class="section-title">{% trans "Корзина" %}</h1>

  {% if messages %}
    <div class="auth-alert" style="margin-bottom: 24px;">
      {% for m in messages %}{{ m }}{% endfor %}
    </div>
  {% endif %}

  {% if items %}
    <div class="grid-2" style="align-items: flex-start; gap: 32px;">

      <!-- Левая колонка: товары -->
      <div style="display: flex; flex-direction: column; gap: 16px;">

        <!-- ВЕРСИЯ ДЛЯ ДЕСКТОПА: ТАБЛИЦА -->
        <div class="orders-table">
          <table class="table">
            <thead>
              <tr>
                <th colspan="2">{% trans "Товар" %}</th>
                <th>{% trans "Цена" %}</th>
                <th style="width: 120px;">{% trans "Кол-во" %}</th>
                <th>{% trans "Сумма" %}</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for it in items %}
              <tr id="row-{{ it.id }}">
                <td style="width: 80px; padding-right: 0;">
                  {% if it.product.image %}
                    <img src="{{ it.product.image.url }}" alt="" style="width: 64px; height: 64px; object-fit: cover; border-radius: 8px;">
                  {% endif %}
                </td>
                <td>
                  <a href="/p/{{ it.product.base_slug }}/">{{ it.product.translations.title|default:it.product }}</a>
                </td>
                <td>{{ it.unit_price_snapshot|money }} {{ it.product.currency }}</td>
                <td>
                  <input type="number" min="1" class="qty-input"
                         name="qty" value="{{ it.qty }}"
                         hx-post="{% url 'cart:update_item' %}"
                         hx-include="closest tr"
                         hx-vals='{"item_id":"{{ it.id }}"}'
                         hx-trigger="change, keyup delay:400ms"
                         hx-target="#row-{{ it.id }}"
                         hx-swap="outerHTML">
                </td>
                <td><b class="price">{{ it.unit_price_snapshot|mul:it.qty }} {{ it.product.currency }}</b></td>
                <td>
                  <form action="/cart/remove/{{ it.id }}/" method="post">
                    {% csrf_token %}
                    <button class="btn secondary" type="submit" style="padding: 8px 16px;">{% trans "Удалить" %}</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- ВЕРСИЯ ДЛЯ МОБИЛЬНЫХ: КАРТОЧКИ -->
        <div class="orders-cards">
          {% for it in items %}
          <div class="order-card" id="card-{{ it.id }}">
            <!-- Верхняя часть: фото и название -->
            <div style="display: flex; gap: 16px; align-items: flex-start;">
                {% if it.product.image %}
                  <img src="{{ it.product.image.url }}" alt="" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border);">
                {% endif %}
              <div style="flex: 1;">
                <a href="/p/{{ it.product.base_slug }}/" style="font-weight: 600; color: var(--text); line-height: 1.3;">{{ it.product.translations.title|default:it.product }}</a>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">{{ it.unit_price_snapshot|money }} {{ it.product.currency }} / шт.</div>
              </div>
            </div>

            <!-- Нижняя часть: управление и цена -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
              <input type="number" min="1" class="qty-input"
                     name="qty" value="{{ it.qty }}"
                     hx-post="{% url 'cart:update_item' %}"
                     hx-vals='{"item_id":"{{ it.id }}"}'
                     hx-trigger="change, keyup delay:400ms"
                     hx-target="#card-{{ it.id }}"
                     hx-swap="outerHTML">

              <div style="text-align: right;">
                <div class="price" style="font-size: 20px;">{{ it.unit_price_snapshot|mul:it.qty }} {{ it.product.currency }}</div>
                <form action="/cart/remove/{{ it.id }}/" method="post" style="margin-top: 4px;">
                    {% csrf_token %}
                    <button type="submit" style="background:none; border:none; color:var(--danger); font-size:13px; cursor:pointer; padding: 4px;">{% trans "Удалить" %}</button>
                </form>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Правая колонка: итоги -->
      <div id="cart-summary" class="card" style="position: sticky; top: 80px;"
           hx-get="{% url 'cart:summary_fragment' %}"
           hx-trigger="cart-recalc from:body"
           hx-swap="outerHTML">
        <h3 style="margin-bottom: 20px;">{% trans "Сумма заказа" %}</h3>
        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 18px;">
          <span>{% trans "Итого" %}:</span>
          <span class="price">{{ subtotal }} GEL</span>
        </div>
        <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">
        <a class="btn" href="/checkout/" style="width: 100%;">{% trans "Оформить заказ" %}</a>
      </div>
    </div>
  {% else %}
    <div class="empty-state">
      <div class="empty-icon" aria-hidden="true">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
      </div>
      <h2 style="margin:0 0 6px;">{% trans "Тут пусто" %}</h2>
      <p style="color: var(--text-secondary); margin:0 0 16px;">{% trans "Добавьте товары из каталога, чтобы оформить заказ." %}</p>
      <a class="btn secondary" href="{% url 'catalog:product_list' %}">{% trans "Перейти в каталог" %}</a>
    </div>
  {% endif %}
</div>
{% endblock %}