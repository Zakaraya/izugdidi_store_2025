{% extends "base.html" %}
{% load i18n %}
{% load cart_extras %}
{% block title %}{% trans "Оформление заказа" %}{% endblock %}

{% block content %}
<div class="container">
  <h1 class="section-title">{% trans "Оформление заказа" %}</h1>

  {% if messages %}
    <div class="auth-alert" style="margin-bottom: 24px;">
      {% for m in messages %}{{ m }}{% endfor %}
    </div>
  {% endif %}

  {% if items %}
    <form id="checkout-form" method="post" action="">
      {% csrf_token %}
      <div class="checkout-grid" style="align-items: flex-start;">

        <!-- Левая колонка: Форма -->
        <div style="display: flex; flex-direction: column; gap: 24px;">

          <!-- Блок 1: Контакты -->
          <div class="card">
            <h3>{% trans "1. Ваши контакты" %}</h3>
            <div style="display: flex; flex-direction: column; gap: 16px;">
              <div class="grid-2">
                <div style="display: flex; flex-direction: column; gap: 6px;">
                  <label for="{{ form.customer_name.id_for_label }}">{% trans "Имя и фамилия" %}</label>
                  {{ form.customer_name }}
                </div>
                <div style="display: flex; flex-direction: column; gap: 6px;">
                  <label for="{{ form.phone.id_for_label }}">{% trans "Телефон" %}</label>
                  {{ form.phone }}
                </div>
              </div>
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <label for="{{ form.email.id_for_label }}">Email</label>
                {{ form.email }}
              </div>
            </div>
          </div>

          <!-- Блок 2: Доставка -->
          <div class="card">
            <h3>{% trans "2. Способ получения" %}</h3>
            <div style="display: flex; flex-direction: column; gap: 16px;">
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <label for="{{ form.delivery_method.id_for_label }}">{% trans "Способ получения" %}</label>
                <select name="delivery_method" id="{{ form.delivery_method.id_for_label }}" class="input"
                        hx-get="{% url 'orders:checkout_address_fields' %}"
                        hx-trigger="change"
                        hx-target="#address-fields-wrapper"
                        hx-swap="innerHTML">
                    <option value="pickup"{% if form.delivery_method.value == 'pickup' %} selected{% endif %}>{% trans "Самовывоз" %}</option>
                    <option value="address"{% if form.delivery_method.value == 'address' %} selected{% endif %}>{% trans "Доставка по адресу" %}</option>
                </select>
              </div>

              <div id="address-fields-wrapper">
                  {% include "orders/_address_fields.html" with method=form.delivery_method.value|default:'pickup' form=form %}
              </div>

              <!-- ВОЗВРАЩЕННЫЙ БЛОК -->
              <div id="billing-checkbox-wrapper" style="display: {% if form.delivery_method.value == 'address' %}flex{% else %}none{% endif %}; align-items: center; gap: 8px;">
                  {{ form.billing_same }}
                  <label for="{{ form.billing_same.id_for_label }}">{{ form.billing_same.label }}</label>
              </div>

              <div id="billing-fields-wrapper" style="display:none;">
                  <div style="display: flex; flex-direction: column; gap: 6px;">
                      <label for="{{ form.billing_address.id_for_label }}">{% trans "Платёжный адрес" %}</label>
                      {{ form.billing_address }}
                  </div>
              </div>
              <!-- КОНЕЦ ВОЗВРАЩЕННОГО БЛОКА -->
            </div>
          </div>

          <!-- Блок 3: Промокод -->
          <div class="card">
            <h3>{% trans "Промокод" %}</h3>
            <div style="display: flex; gap: 8px;">
                <div style="flex: 1;">
                    {{ form.promo_code }}
                </div>
                <button class="btn secondary" type="submit" name="action" value="apply">{% trans "Применить" %}</button>
            </div>
            {% if applied_code %}
              <p style="font-size: 13px; color: var(--success); margin-top: 8px;">{% trans "Применён" %}: <b>{{ applied_code }}</b></p>
            {% endif %}
          </div>
        </div>

        <!-- Правая колонка: Состав заказа -->
        <div style="position: sticky; top: 80px; display: flex; flex-direction: column; gap: 16px;">
          <!-- Содержимое правой колонки без изменений -->
          <div class="card">
            <h3 style="margin-bottom: 16px;">{% trans "Ваш заказ" %}</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              {% for it in items %}
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                <span style="font-size: 14px; line-height: 1.4;">{{ it.product.translations.title|default:it.product }} (×{{ it.qty }})</span>
                <span style="font-weight: 600; white-space: nowrap;">{{ it.unit_price_snapshot|mul:it.qty }} {{ it.product.currency }}</span>
              </div>
              {% endfor %}
            </div>
            <hr style="border: none; border-top: 1px solid var(--border); margin: 16px 0;">
            <div style="display: flex; flex-direction: column; gap: 8px; font-size: 14px;">
              <div style="display: flex; justify-content: space-between;"><span>{% trans "Подытог" %}:</span> <b>{{ subtotal }} GEL</b></div>
              <div style="display: flex; justify-content: space-between;"><span>{% trans "Доставка" %}:</span> <b>{{ shipping_total }} GEL</b></div>
              {% if discount_total > 0 %}
              <div style="display: flex; justify-content: space-between; color: var(--success);">
                <span>{% trans "Скидка" %}{% if applied_code %} ({{ applied_code }}){% endif %}:</span>
                <b>-{{ discount_total }} GEL</b>
              </div>
              {% endif %}
            </div>
            <hr style="border: none; border-top: 1px solid var(--border); margin: 16px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 18px;">
              <b>{% trans "Итого к оплате" %}:</b>
              <span class="price">{{ total }} GEL</span>
            </div>
          </div>
          <button class="btn" type="submit" form="checkout-form" name="action" value="place" style="width:100%;">
            {% trans "Подтвердить и оплатить" %}
          </button>
        </div>
      </div>
    </form>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const deliverySelect = document.querySelector('[name="delivery_method"]');
      const billingCheckbox = document.querySelector('[name="billing_same"]');
      const billingCheckboxWrapper = document.getElementById('billing-checkbox-wrapper');
      const billingFieldsWrapper = document.getElementById('billing-fields-wrapper');

      function toggleBillingFields() {
        if (!billingCheckbox || !billingFieldsWrapper) return;
        billingFieldsWrapper.style.display = billingCheckbox.checked ? 'none' : 'block';
      }

      function toggleBillingCheckboxVisibility() {
        if (!deliverySelect || !billingCheckboxWrapper) return;
        billingCheckboxWrapper.style.display = deliverySelect.value === 'address' ? 'flex' : 'none';
        if (deliverySelect.value !== 'address') {
            billingFieldsWrapper.style.display = 'none';
        } else {
            toggleBillingFields();
        }
      }

      if (billingCheckbox) {
        billingCheckbox.addEventListener('change', toggleBillingFields);
      }
      if (deliverySelect) {
        // Слушаем и стандартное событие, и событие от HTMX
        deliverySelect.addEventListener('change', toggleBillingCheckboxVisibility);
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'address-fields-wrapper') {
                toggleBillingCheckboxVisibility();
            }
        });
      }

      // Первоначальный вызов
      toggleBillingCheckboxVisibility();
      toggleBillingFields();
    });
    </script>

  {% else %}
    <div class="empty-state">
      <h2 style="margin:0 0 6px;">{% trans "Ваша корзина пуста" %}</h2>
      <p style="color: var(--text-secondary); margin:0 0 16px;">{% trans "Вы не можете оформить заказ, пока не добавите товары." %}</p>
      <a class="btn secondary" href="{% url 'catalog:product_list' %}">{% trans "Перейти в каталог" %}</a>
    </div>
  {% endif %}
</div>
{% endblock %}